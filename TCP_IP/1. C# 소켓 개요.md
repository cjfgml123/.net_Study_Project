### 1. C# 소켓 개요

- C#의 소켓은 System.Net 네임스페이스에서 제공하고 있다.

#### 1-1) 소켓

- 네트워크(인터넷)의 연결 도구
- 클라이언트 소켓과 서버 소켓으로 두 가지 나눌 수 있다.

ex) A라는 전화기가 B라는 전화기에 전화를 하게 되면 둘이 연결되고 데이터를 주고 받는다.

전화기는 각각 서로 직접적으로 연결된게 아니라 전화망을 통해서 연결되기 때문에 전화망에 연결하는 도구가 되는 것이다. TCP 소켓을 전화기에 비유하면 먼저 해야할 일은 소켓의 생성, 즉 전화기의 구입이다.

```C#
// 서버 소켓 생성자 설명
 Socket server = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
```

##### 1-1-1) AddressFamily옵션 , System.Net.Sockets.AddressFamily 열거형

- AddressFamily 옵션은 다루게될 소켓의 주소 체계를 선택한다. 우리가 사용할 것은 InterNetwork(ipx, lrda, lso ...)이다. ( ex) :IPv4, IPv6 ...)

##### 1-1-2) SocketType옵션 ,System.Net.Sockets.SocketType 열거형

- 프로토콜이 통신할 소켓 타입을 지정합니다. TCP/IP에서 사용될 프로토콜은 크게 TCP와 UDP 방식이 있다. 여기서 TCP 방식은 Stream으로 열거형으로 정의 되어 있고, UDP는 Dgram으로 되어 있다. (Raw ,Rdm, Seqpacket등등)

##### 1-1-3) ProtocolType옵션, System.Net.Sockets.ProtocolType 열거형

- 소켓의 프로토콜 형식을 열거형으로 지정해 줄 수 있다. 중요한 것은 SocketType이나 Address Family 의 옵션에서 지정된 주소체계와 매칭이 되어야 한다.

```C#
// SocketType.Stream과 ProtocolType.Tcp와 같이 호환되는 ProtocolType을 정확히 설정하는것이 중요한다.(아래 예를 참고)

Socket tcpSocket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);

Socket UdpSocket = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);
```

##### 1-1-4) 소켓 통신을 위한 서버/ 클라이언트 구성하기(구성도)

- Socket을 통한 데이터 통신은 모두 Byte를 이용하여 통신을 하게 된다. 그래서 데이터 전송시 Byte[] 배열에 데이터를 입력하고 Send/Receive 를 하게 됩니다. 참고로 Obj는 소켓 객체를 말한다.

| server                                                       | Client                                       |
| ------------------------------------------------------------ | -------------------------------------------- |
| 소켓준비(IPAddress , Port)                                   | 소켓준비(서버측 IPAddress,Port)              |
| 소켓 개방/바인드,Socket()서버측 옵션 설정 Socket.Bind(IPAddress,Port); | 원격호스트 연결,Obj.Connect(IPaddress,Port); |
| 연결리스닝, Socket.Listener();                               | 데이터 송.수신 Obj.Send(), Obj.Receive();    |
| Client 연결허용, Socket.Accept();                            | 소켓 종료 Obj.Shutdown(); Obj.Close();       |
| 데이터 송수신, Obj.Send()/Obj.Receive()                      |                                              |
| 소켓종료,Obj.Shutdown(); Obj.Close();                        |                                              |





### 2. 클래스

#### 2-1. IPAddress 클래스

- C# 에서 IP 주소를 다루기 위한 클래스이다.

| 메서드명           | 메서드 설명                                                  |
| ------------------ | ------------------------------------------------------------ |
| HostToNetworkOrder | 호스트 바이트 순서에서 네트워크 바이트 순서로 값을 변환한다. |
| NetworkToHostOrder | 네트워크 바이트 순서에서 호스트 바이트 순서로 숫자를 변환한다. |
| Parse              | IP 주소 문자열을 IPAddress 클래스의 인스턴스로 변환한다.     |
| ToString           | 인터넷 주소를 네 개의 점으로 구분된 표준 형식으로 변환한다.  |

```C#
//IPAddress 클래스를 이용하여 정수 100을 네트워크 바이트 순서로 바꾸는 코드
int iData = 100;
iData = IPAddress.HostToNetworkOrder(iData);
```



#### 2-2. IPEndPoint 클래스

- 호스트 서비스에 연결하기 위해 응용 프로그램에 필요한 호스트 및 포트 정보가 포함되어 있다.
- 호스트의 IP 주소와 서비스의 포트 번호를 결합하여 서비스에 대한 연결 지점을 형성한다.

| 메서드명 | 메서드 설명                                  |
| -------- | :------------------------------------------- |
| Create   | 소켓 주소를 사용하여 종점을 만든다.          |
| ToString | 지정된 종점의 IP주소와 포트 번호를 반환한다. |

```C#
// IPEndPoint 클래스를 이용하여 서버 소켓으로 접속하는 코드
Socket oSocket = null;
try 
{
 	//연결 종점 생성
    EndPoint oEP = new IPEndPoint(IPAddress.Parse("192.168.1.100"),2000);
    
    // 소켓 객체 생성
    oSocket = new Socket(AddressFamily.InterNetwork, SocketType.Stream,ProtocolType.Tcp);
    
    //연결 시도
    oSocket.Connect(oEP);
}
catch{
    //연결실패
}
```



#### 2-3. Socket 클래스

- C#에서 소켓 통신을 하기 위해서 Socket 클래스를 제공한다.
- 자바와는 다르게 Send/Receive 메소드를 제공하여 읽기/쓰기가 가능하며 서버 소켓 클래스가 따로 존재하지 않는다.

| 메소드명    | 메소드 설명                                                  |
| ----------- | ------------------------------------------------------------ |
| Accept      | 클라이언트의 연결 요청을 받아들인다. 클라이언트 소켓 클래스 인스턴스가 반환된다. |
| Bind        | Socket을 로컬 종점과 연결한다.                               |
| Listen      | Socket을 수신 대기 상태로 둔다.                              |
| Connect     | 서버 소켓에 연결을 시도한다.                                 |
| Close       | 소켓의 연결을 해제                                           |
| Receive     | 연결된 상대에게서 데이터를 수신 받는다.                      |
| ReceiveFrom | 상대에게서 데이터그램을 데이터를 수신 받는다.                |
| Send        | 연결된 상대에게 데이터를 송신한다.                           |
| SendTo      | 특정 종점에 데이터를 송신한다.                               |
| ShutDown    | Socket의 보내기 또는 받기를 사용할 수 없도록 한다.           |

```C# 
// Socket 클래스를 이용하여 서버 소켓을 구현
Socket oServerSocket = new Socket(AddressFamily.InterNetwork,
                                 SocketType.Stream,ProtocolType.Tcp);
// TCP 포트 2000 번 종점 객체 생성
EndPoint oLocalEP = new IPEndPoint(IPAddress.Any, 2000);

// TCP 포트 2000번 서버 소켓 바인딩
oServerSocket.Bind(oLocalEP);
oServerSocket.Listen(5);

Socket oSocket = null;

try
{
    while(true)
    {
        // 클라이언트 접속 요청 수락
        oSocket = oServerSocket.Accept();
    }
}
catch
{
    // 서버 소켓 에러
}
```



#### 2-4. NetworkStream 클래스

- C# Socket 클래스의 Send/Receive 메소드는 빈번한 입/출력 시 블록(Block)되는 현상이 발생하여 NetworkStream 클래스를 사용하여 해결한 적이 있다.

| 메소드명  | 메소드 설명                                                  |
| --------- | ------------------------------------------------------------ |
| Close     | 스트림을 닫고 필요에 따라 내부 소켓을 닫는다.                |
| Read      | 스트림에서 데이터를 읽는다.                                  |
| ReadByte  | 스트림에서 바이트를 읽고 스트림 내 위치를 한 바이트씩 앞으로 이동하거나 스트림 끝일 경우 -1을 반환한다. |
| Write     | 스트림에 데이터를 쓴다.                                      |
| WriteByte | 스트림의 현재 위치에 바이트를 쓰고 스트림 내 위치를 1 바이트씩 앞으로 이동한다. |

```C#
//NetworkStream 클래스를 이용하여 스트림 데이터를 읽는 코드이다.

// NetworkStream 클래스 인스턴스 생성
NetworkStream oNS = new NetworkStream(oSocket);

// 소켓 읽기 버퍼 할당
byte[] byteBuffer = new byte[8192];

while(true)
{
    int iRead = 0;
    try{
        //소켓 읽기
        iRead = oNS.Read(byteBuffer, 0, 8192);
        if(iRead <= 0)
            break;
    }
    catch
    {
        //소켓 읽기 실패
        break;
    }
}
```

























































































