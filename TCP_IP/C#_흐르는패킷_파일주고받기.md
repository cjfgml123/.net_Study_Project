### 1. 흐르는 패킷

- 여름철 홍수가 발생하던 지역에 댐을 만들으면 홍수를 예방할 수 있다. TCP 통신 애플리케이션도 이 댐과 같은 역할을 하는 "버퍼(buffer)"를 갖고 있다. 애플리케이션에서 네트워크를 향해 내보내는 데이터도, 들어오는 데이터도 이 버퍼를 거친다.



### 2. 프로토콜 설계와 네트워크 애플리케이션 프로그래밍

- 컴퓨터에서 사용하던 객체를 바이트 스트림을 바꿔 내보낸다.
- 바이트 스트림으로 들어온 데이터를 내 컴퓨터에서 다루기 위해 객체로 바꿔야 한다.
- 수신한 데이터가 정상적인지 검사
- 안정성을 위해 연결 상태도 수시로 점검



### 3. 파일 업로드 프로토콜(직접만든 프로토콜) : FUP

- 바디와 헤더 두 부분으로 나눌 것

  - 헤더 : 본문 길이를 비롯해 메시지의 속성 몇 가지를 담는다.
  - 바디 : 길이는 담는 데이터에 따라 달라지지만 헤더의 길이는 16바이트로 일정함.

  즉, 수신한 패킷을 분석할 때는 가장 먼저 16바이트를 먼저 확인해서 (바디의 길이를 포함한) 메시지의 속성을 확인하고 그 다음에 바디의 길이만큼을 또 읽어 하나의 메시지 끝을 끊어내야 한다.



- FUP의 헤더가 갖고 있는 각 속성 필드 설명

| 필드이름   | 크기(바이트) | 설명                                                         |
| ---------- | ------------ | ------------------------------------------------------------ |
| MSGID      | 4            | 메시지 식별 번호                                             |
| MSGTYPE    | 4            | 메시지의 종류 1. 0x01 : 파일전송 요청 2. 0x02 : 파일 전송 요청에 대한 응답 3. 0x03 : 파일 전송 데이터 4. 0x04 : 파일 수신 결과 |
| BODYLEN    | 4            | 메시지 본문의 길이(단위 : 바이트)                            |
| FRAGMENTED | 1            | 메시지의 분할 여부 1. 미분할 : 0x0, 분할 : 0x1               |
| LASTMSG    | 1            | 분할된 메시지가 마지막인지 여부 1. 마지막 아님 :0x0 2. 마지막 0x1 |
| SEQ        | 2            | 메시지의 파편 번호                                           |



- MSGTYPE에 따른 바디의 종류

1. MSGTYPE = 파일 전송 요청(0x01)인 경우 바디의 구조				
   - 이 메시지는 클라이언트에서 사용

| 필드이름 | 크기(바이트)            | 설명                            |
| -------- | ----------------------- | ------------------------------- |
| FILESIZE | 8                       | 전송할 파일 크기(단위 : 바이트) |
| FILENAME | BODYEN-FILESIZE(8 byte) | 전송할 파일의 이름              |

2. MSGTYPE = 파일 전송 요청에 대한 응답 (0x02)인 경우 바디의 구조				

- 이 메시지는 서버에서 사용
- 클라이언트에서 보낸 파일 전송 요청(0x01) 메시지의 메시지 식별 번호와 같이 결과를 클라이언트에 전송함.

| 필드이름 | 크기(바이트) | 설명                                             |
| -------- | ------------ | ------------------------------------------------ |
| MSGID    | 4            | 파일 전송 요청 메시지(0x01)의 메시지 식별 번호   |
| RESPONSE | 1            | 파일 전송 승인 여부 1. 거절 : 0x0  2. 승인 : 0x1 |

3. MSGTYPE = 파일 전송 데이터 (0x03)인 경우 바디의 구조				

- 파일 전송 요청에 대한 응답(0x02) 메시지의 RESPONSE 필드가 0x1을 담고 클라이언트에 돌아오면, 클라이언트는 파일 전송을 개시한다.
- 클라이언트의 파일은 네트워크 전송에 알맞도록 잘게 쪼개져서 파일 전송 데이터(0x03) 메시지에 담겨 서버로 날아간다. 이 경우 FUP의 바디는 DATA만 담는다.

| 필드이름 | 크기(바이트)   | 설명      |
| -------- | -------------- | --------- |
| DATA     | 헤더의 BODYLEN | 파일 내용 |

4. MSGTYPE = 파일 수신 결과 (0x04)인 경우 바디의 구조				

- 클라이언트가 마지막 파일 데이터를 전송할 때는 파일 전송 데이터 메시지 헤더의 LASTMSG필드에 0x01을 담아 보낸다. 마지막 파일 전송 데이터 메시지를 수신한 서버는 파일이 제대로 수신됐는지를 확인해서 파일 수신 결과(0x04) 메시지를 클라이언트에 보낸다. 이때 메시지 바디에는 파일 전송 데이터(0x03) 메시지의 MSGID와 파일 수신 결과가 함께 담긴다.

| 필드이름 | 크기(바이트) | 설명                                             |
| -------- | ------------ | ------------------------------------------------ |
| MSGID    | 4            | 파일 전송 데이터(0x03)의 식별 번호               |
| RESULT   | 1            | 파일 전송 성공 여부 1. 실패 : 0x0, 2. 성공 : 0x1 |



### 4. 파일 업로드 서버와 클라이언트 구현하기

- 서버/클라이언트 공용 클래스 라이브러리 구현
- 서버 구현
- 클라이언트 구현

#### 4-1) 서버/ 클라이언트가 같이 사용할 클래스 라이브러리 만들기



#### 4-2) 파일 업로드 서버 구현하기

#### 4-3) 클라이언트 구현하기

